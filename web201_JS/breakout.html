<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>breakout</title>
  <style>
    canvas {
      border: solid 10px #66ba66;
    }
  </style>
</head>

<body>
  <canvas id='canvas' width=600 height=600></canvas>

  <script src="debug.js"></script>
  <script>
    var canvas = document.querySelector('canvas');
    var ctx = canvas.getContext('2d');

    // 
    // events
    window.addEventListener('keydown', function (e) {
      console.log(e.code);
    });

    let left = null;
    let right = null;

    window.addEventListener('keydown', function (e) {
      if (e.code === "ArrowLeft") {
        left = true;
      }
      else if (e.code === "ArrowRight") {
        right = true;
      } else if (e.code === 'Space') {
        pause = !pause; // toggle the value
      }
    });

    window.addEventListener('keyup', function (e) {
      if (e.code === "ArrowLeft") {
        left = false;
      }
      else if (e.code === "ArrowRight") {
        right = false;
      }
    });

    //
    function collisionOnTop(circle, rect) {
      return circle.x >= rect.x // left edge
        && circle.x <= rect.x + rect.w // right edge
        && circle.y + circle.r >= rect.y // hit on top
        && circle.y + circle.r < rect.y + rect.h;
    }
    function collisionOnLeft(circle, rect) {
      return circle.x + circle.r >= rect.x &&
        circle.y >= rect.y &&
        circle.y <= rect.y + rect.h &&
        circle.x + circle.r < rect.x + rect.w;
    }
    function collisionOnRight(circle, rect) {
      return circle.x - circle.r <= rect.x + rect.w // left edge of the ball less than the right edge of the rect
        && circle.y >= rect.y
        && circle.y <= rect.y + rect.h
        && circle.x - circle.r > rect.x;
    }
    function collisionOnBottom(circle, rect) {
      if (circle.y - circle.r <= rect.y + rect.h
        && circle.x >= rect.x
        && circle.x <= rect.x + rect.w
        && circle.y - circle.r > rect.y) {
        console.log("Collision on bottom")
        return true;
      }
      else {
        return false;
      }
    }
    // write text
    function drawText(text,x,y,color) {
      ctx.beginPath();
      ctx.font="20px monospace";
      ctx.fillStyle=color;
      ctx.fillText(text,x,y);
    }

    // block
    block = {
      r: 0,
      c: 0,
      x: 200,
      y: 100,
      w: 80,
      h: 20,
      exist: true,
      draw: function () {
        if (!this.exist) return;
        ctx.beginPath();
        ctx.rect(this.x, this.y, this.w, this.h);
        ctx.fill();
      },
      update: function () {
      }
    }

    // 3,10
    function createBlocks(rows, cols) {
      let blocks = [];
      for (let r = 0; r < rows; r++) {
        let newRow = [];
        for (let c = 0; c < cols; c++) {
          let b = { ...block };
          // row, col -> b.x, b.y
          /*
          x = col * (w+30)
          y = row * (h+20)
          */
          b.r = r;
          b.c = c;
          b.x = c * (b.w + 30) + 50;
          b.y = r * (b.h + 20) + 50;
          newRow.push(b);
        }
        blocks.push(newRow);
      }
      return blocks;
    }

    let rows = 3;
    let cols = 5;
    let blocks = createBlocks(rows, cols);
    console.log(blocks);

    // paddle
    let paddle = {
      x: canvas.width / 2 - 80,
      y: canvas.height - 20,
      w: 160,
      h: 20,
      dx: 5,
      draw: function () {
        ctx.beginPath();
        ctx.rect(this.x, this.y, this.w, this.h);
        ctx.fillStyle = 'black';
        ctx.fill();
      },
      update: function () {
        if (left) {
          if (this.x - this.dx >= 0) {
            this.x -= this.dx;
          }
        }
        if (right) {
          if (this.x + this.w + this.dx <= canvas.width) {
            this.x += this.dx;
          }
        }
      }
    }

    paddle.draw();

    // ball
    let maxAngle = 160;
    let minAngle = 20;

    let ball = {
      x: canvas.width / 2,
      y: canvas.height - paddle.h - 15,
      dx: 10, // delta x
      dy: -12,
      r: 15,
      draw: function () {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        ctx.fillStyle = 'blue';
        ctx.fill();
      },
      update: function () {
        // ball hit blocks
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (blocks[r][c].exist && (collisionOnTop(this, blocks[r][c])
              || collisionOnLeft(this, blocks[r][c])
              || collisionOnRight(this, blocks[r][c])
              || collisionOnBottom(this, blocks[r][c]))) {
                blocks[r][c].exist=false;
                this.dy*=-1;
                score += 10; // Increase score by 10 when a block is hit
            }
          }
        }
        // ball hit left or right of canvas
        if (this.x - this.r <= 0 || this.x + this.r >= canvas.width) {
          this.dx *= -1;
        }
        // hit paddle
        if (collisionOnTop(this, paddle)) {
          /*
          ball.x, paddle.x -> hitX
          hitX -> angle
          dx, dy -> energy
          energy, angle -> new dx, new dy
          */
          let hitX = ball.x - paddle.x;
          let angle = maxAngle - Math.floor((maxAngle - minAngle) / paddle.w * hitX);
          let energy = (this.dx ** 2 + this.dy ** 2) ** 0.5;
          this.dx = energy * Math.cos(angle * Math.PI / 180);
          this.dy = -energy * Math.sin(angle * Math.PI / 180);
          // console.log('dx,dy',this.dx,this.dy);
        }
        // ball hit top or bottom of canvas
        if (this.y - this.r <= 0 || this.y + this.r >= canvas.height) {
          this.dy *= -1;
        }
        this.x += this.dx;
        this.y += this.dy;
      }
    }

    // ball.update();
    ball.draw();

    let pause = false;
    let score = 0;
    // game loop
    function loop() {
      requestAnimationFrame(loop);
      if (pause) return;
      // 1 clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 2 draw
      drawText("Score: "+score, 10,20,'blue');
      blocks.forEach(function (row) {
        row.forEach(function (block) {
          block.draw();
        });
      });
      paddle.draw();
      ball.draw();

      // 3 update
      blocks.forEach(function (row) {
        row.forEach(function (block) {
          block.update();
        });
      });
      paddle.update();
      ball.update();
    }

    loop();

  </script>

</body>

</html>
